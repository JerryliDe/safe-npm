import type { ScanIssue } from './types.js';
import { t } from '../i18n/index.js';
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

interface NpmAuditVuln {
  severity: 'info' | 'low' | 'moderate' | 'high' | 'critical';
  title: string;
  url: string;
}

export async function scanVulnerabilities(packageName: string): Promise<ScanIssue[]> {
  const issues: ScanIssue[] = [];

  try {
    // Use npm audit to check for known vulnerabilities
    // Note: This is a simplified implementation
    // In reality, we'd need to create a temp package.json to audit specific packages
    const { stdout } = await execAsync(
      `npm audit --json --package-lock-only 2>nul || echo {}`,
      {
        timeout: 30000,
      }
    );

    if (!stdout.trim() || stdout.trim() === '{}') {
      return issues;
    }

    try {
      const auditResult = JSON.parse(stdout);

      // Check if our package is in the vulnerabilities
      const vulns = auditResult.vulnerabilities || {};

      if (vulns[packageName]) {
        const vuln = vulns[packageName];
        const severity = vuln.severity;

        if (severity === 'critical' || severity === 'high') {
          issues.push({
            type: 'cve',
            severity: 'warning', // CVEs are warnings, not blockers
            message: t('cveFound'),
            details: `${severity.toUpperCase()}: ${vuln.via?.[0]?.title || 'Known vulnerability'}`,
          });
        }
      }
    } catch {
      // JSON parse failed, skip
    }
  } catch {
    // Audit failed, skip vulnerability check
  }

  return issues;
}
